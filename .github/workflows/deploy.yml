name: ðŸš€ CI/CD - Frontend & Backend

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'
  GO_VERSION: '1.23'
  REGISTRY: docker.io
  IMAGE_NAME: groupietracker/backend

jobs:
  # ============================================
  # JOB 1: TESTS & LINT FRONTEND
  # ============================================
  frontend-tests:
    name: ðŸŽ¨ Frontend - Tests & Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ§ª Run ESLint
        run: npm run lint || true

      - name: ðŸ” TypeScript Check
        run: npx tsc --noEmit

      - name: ðŸ§ª Run tests (si prÃ©sents)
        run: npm test || echo "No tests configured"

      - name: ðŸ“Š Build check
        run: npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_STRIPE_PUBLIC_KEY: ${{ secrets.VITE_STRIPE_PUBLIC_KEY }}
          VITE_SENTRY_DSN: ${{ secrets.VITE_SENTRY_DSN }}

  # ============================================
  # JOB 2: TESTS & LINT BACKEND
  # ============================================
  backend-tests:
    name: ðŸ”§ Backend - Tests & Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: backend/go.sum

      - name: ðŸ“¥ Install dependencies
        run: go mod download

      - name: ðŸ” Run go vet
        run: go vet ./...

      - name: ðŸ§ª Run tests
        run: go test ./... -v -cover

      - name: ðŸ“Š Build check
        run: go build -o api main.go

  # ============================================
  # JOB 3: BUILD & PUSH DOCKER IMAGE
  # ============================================
  docker-build:
    name: ðŸ³ Docker - Build & Push
    runs-on: ubuntu-latest
    needs: [backend-tests]
    if: github.ref == 'refs/heads/main'
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”‘ Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ðŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ðŸ—ï¸ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # ============================================
  # JOB 4: RUN MIGRATIONS (PostgreSQL Neon)
  # ============================================
  run-migrations:
    name: ðŸ—„ï¸ Database - Run Migrations
    runs-on: ubuntu-latest
    needs: [docker-build]
    if: github.ref == 'refs/heads/main'
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: ðŸ”§ Install golang-migrate
        run: |
          curl -L https://github.com/golang-migrate/migrate/releases/latest/download/migrate.linux-amd64.tar.gz | tar xvz
          sudo mv migrate /usr/local/bin/migrate

      - name: ðŸš€ Run migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          migrate -path database/migrations -database "$DATABASE_URL" up

  # ============================================
  # JOB 5: DEPLOY BACKEND TO AZURE ACI
  # ============================================
  deploy-backend:
    name: â˜ï¸ Deploy Backend to Azure ACI
    runs-on: ubuntu-latest
    needs: [run-migrations]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ”‘ Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ðŸš€ Deploy to Azure Container Instances
        uses: azure/aci-deploy@v1
        with:
          resource-group: ${{ secrets.AZURE_RESOURCE_GROUP }}
          dns-name-label: groupietracker-api
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          registry-login-server: ${{ env.REGISTRY }}
          registry-username: ${{ secrets.DOCKER_USERNAME }}
          registry-password: ${{ secrets.DOCKER_PASSWORD }}
          name: groupietracker-backend
          location: 'westeurope'
          cpu: 1
          memory: 1.5
          ports: 8080
          environment-variables: |
            PORT=8080
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
            STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            SENDGRID_API_KEY=${{ secrets.SENDGRID_API_KEY }}
            MINIO_ENDPOINT=${{ secrets.MINIO_ENDPOINT }}
            MINIO_ACCESS_KEY=${{ secrets.MINIO_ACCESS_KEY }}
            MINIO_SECRET_KEY=${{ secrets.MINIO_SECRET_KEY }}
            SENTRY_DSN=${{ secrets.SENTRY_DSN_BACKEND }}
            ALLOWED_ORIGINS=${{ secrets.ALLOWED_ORIGINS }}

      - name: âš™ï¸ Enable Scale to Zero (Cost Optimization)
        run: |
          az container update \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --name groupietracker-backend \
            --set containers[0].resources.requests.cpu=0.5 \
            --set containers[0].resources.requests.memoryInGB=0.5

  # ============================================
  # JOB 6: DEPLOY FRONTEND TO NETLIFY
  # ============================================
  deploy-frontend:
    name: ðŸŒ Deploy Frontend to Netlify
    runs-on: ubuntu-latest
    needs: [frontend-tests]
    if: github.ref == 'refs/heads/main'
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build production
        run: npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_STRIPE_PUBLIC_KEY: ${{ secrets.VITE_STRIPE_PUBLIC_KEY }}
          VITE_SENTRY_DSN: ${{ secrets.VITE_SENTRY_DSN }}
          VITE_GOOGLE_CLIENT_ID: ${{ secrets.VITE_GOOGLE_CLIENT_ID }}

      - name: ðŸš€ Deploy to Netlify
        uses: nwtgck/actions-netlify@v2
        with:
          publish-dir: './frontend/dist'
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy from GitHub Actions - ${{ github.sha }}"
          enable-pull-request-comment: true
          enable-commit-comment: true
          overwrites-pull-request-comment: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

  # ============================================
  # JOB 7: SENTRY SOURCE MAPS UPLOAD
  # ============================================
  sentry-upload:
    name: ðŸ“Š Sentry - Upload Source Maps
    runs-on: ubuntu-latest
    needs: [deploy-frontend]
    if: github.ref == 'refs/heads/main'
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¥ Install Sentry CLI
        run: npm install -g @sentry/cli

      - name: ðŸ—ï¸ Build with source maps
        run: npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_STRIPE_PUBLIC_KEY: ${{ secrets.VITE_STRIPE_PUBLIC_KEY }}
          VITE_SENTRY_DSN: ${{ secrets.VITE_SENTRY_DSN }}

      - name: ðŸ“¤ Upload source maps to Sentry
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: groupietracker
          SENTRY_PROJECT: frontend
        run: |
          sentry-cli releases new ${{ github.sha }}
          sentry-cli releases files ${{ github.sha }} upload-sourcemaps ./dist --url-prefix '~/'
          sentry-cli releases finalize ${{ github.sha }}
          sentry-cli releases deploys ${{ github.sha }} new -e production

  # ============================================
  # JOB 8: NOTIFICATIONS (Discord/Slack)
  # ============================================
  notify-success:
    name: ðŸ“¢ Notify Deployment Success
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend, sentry-upload]
    if: success()

    steps:
      - name: ðŸ“¢ Discord Notification
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: |
            âœ… **Groupie Tracker - DÃ©ploiement rÃ©ussi!**
            
            ðŸ”¹ **Commit**: ${{ github.sha }}
            ðŸ”¹ **Auteur**: ${{ github.actor }}
            ðŸ”¹ **Branch**: ${{ github.ref_name }}
            
            ðŸŒ **Frontend**: https://groupietracker.netlify.app
            â˜ï¸ **Backend**: https://groupietracker-api.westeurope.azurecontainer.io
            
            ðŸŽ‰ Tous les services sont en ligne!

  notify-failure:
    name: ðŸš¨ Notify Deployment Failure
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: failure()

    steps:
      - name: ðŸš¨ Discord Notification
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: |
            âŒ **Groupie Tracker - Ã‰chec du dÃ©ploiement!**
            
            ðŸ”¹ **Commit**: ${{ github.sha }}
            ðŸ”¹ **Auteur**: ${{ github.actor }}
            ðŸ”¹ **Branch**: ${{ github.ref_name }}
            
            âš ï¸ VÃ©rifiez les logs GitHub Actions immÃ©diatement!
            ðŸ”— ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

# ============================================
# SECRETS REQUIS (GitHub Settings > Secrets)
# ============================================
# 
# DOCKER:
# - DOCKER_USERNAME
# - DOCKER_PASSWORD
#
# AZURE:
# - AZURE_CREDENTIALS (Service Principal JSON)
# - AZURE_RESOURCE_GROUP
#
# DATABASE:
# - DATABASE_URL (Neon PostgreSQL)
#
# BACKEND ENV:
# - STRIPE_SECRET_KEY
# - STRIPE_WEBHOOK_SECRET
# - JWT_SECRET
# - OPENAI_API_KEY
# - GOOGLE_CLIENT_ID
# - GOOGLE_CLIENT_SECRET
# - SENDGRID_API_KEY
# - MINIO_ENDPOINT
# - MINIO_ACCESS_KEY
# - MINIO_SECRET_KEY
# - SENTRY_DSN_BACKEND
# - ALLOWED_ORIGINS
#
# FRONTEND ENV:
# - VITE_API_URL
# - VITE_STRIPE_PUBLIC_KEY
# - VITE_SENTRY_DSN
# - VITE_GOOGLE_CLIENT_ID
#
# NETLIFY:
# - NETLIFY_AUTH_TOKEN
# - NETLIFY_SITE_ID
#
# SENTRY:
# - SENTRY_AUTH_TOKEN
#
# NOTIFICATIONS:
# - DISCORD_WEBHOOK (optionnel)
